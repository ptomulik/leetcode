\documentclass[paper=a4,parskip=half,DIV=12]{leetcode}

\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{courier}
\usepackage{tgtermes,newtxtext,newtxmath}
\usepackage[pdftex,colorlinks,allcolors=blue]{hyperref}
\usepackage{subcaption}
\usepackage{natbib}
\usepackage{float}

\usepackage{amsmath,amsfonts}
\usepackage{tikz}
\usetikzlibrary{arrows,calc,graphs,matrix,quotes,positioning,arrows.meta}

\setcitestyle{numbers,square,comma}

\begin{document}

\serietitle{LeetCode contests solutions}
\title{1601. Maximum Number of Achievable Transfer Requests~\cite{leetcode:1601}}
\subtitle{}
\author{Pawe≈Ç Tomulik}
\date{\today}
\maketitle

\section{Description}
\label{sec:description}

We have $n$ buildings numbered from $0$ to $n - 1$. Each building has a~number
of employees. It's transfer season, and some employees want to change the
building they reside in.

You are given an array \texttt{requests} where \texttt{requests[i] = [from$_i$,
to$_i$]} represents an employee's request to transfer from building
\texttt{from$_i$} to building \texttt{to$_i$}.

All buildings are full, so a list of requests is achievable only if for each
building, the net change in employee transfers is zero. This means the number
of employees leaving is equal to the number of employees moving in. For example
if $n = 3$ and two employees are leaving building $0$, one is leaving building
$1$, and one is leaving building $2$, there should be two employees moving to
building $0$, one employee moving to building $1$, and one employee moving to
building $2$.

Return the \textbf{maximum number of achievable requests}.

\section{Solution}
\label{sec:solution}

This is a~variant of network flow optimization~\cite{ahuja1993network} --
the maximum circulation problem.

\subsection{Complexity}
\label{sec:complexity}

To be determined, but it shall be not worse then $\mathcal{O}(|V|^3 + |A|)$.
Utilizes Tarjan algorithm for strongly connected components ($\mathcal{O}(|V| + |A|)$)
at preprocessing, Dijkstra's shortest path algorithm in main loop loop
(up to $\mathcal{O}(|V|)$ times, I guess) and an iteration which, I guess,
costs $\mathcal{O}(|A|)$.

\subsection{Solution description}
\label{sec:solution-description}

Our problem can be modelled using a~directed graph $G = (V, A)$ with a~set of
nodes $V = \{0, \dots, n-1 \}$ and a~set $A \subseteq V\times V$ of arcs
(ordered pairs $(i,j) \in A$). Nodes represent buildings, arcs correspond to
transfer requests. We~assign a~positive integer $u_{ij}$ to each arc $(i, j)
\in A$
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{equation}
    u_{ij} \in \mathbb{N}, \; (i, j) \in A,
    \label{eq:49EZ8}
\end{equation}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
and set it to the~number of transfer requests from building $i$ to $j$. Let
$r_{ij}$ be the number of achievable requests from $i$ to $j$. In terms of
network flow $r_{ij}: 0 \le r_{ij} \le u_{ij}$ is a network flow over
an individual arc~$(i,j)$ and $u_{ij}$ is the capacity of the arc. The maximum
circulation problem can be stated as follows.

\paragraph{Maximum circulation problem.} Let $r_{ij}$ be a~flow along arc
$(i,j)$ and $r = \left\lbrace r_{ij} \right\rbrace$. Maximize
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{subequations}
  \begin{equation}
    z(r) = \sum_{(i,j) \in A} r_{ij},
    \label{eq:UDSSB}
  \end{equation}
  subject to the constraints
  \begin{align}
    \sum_{j: (j,i) \in A} r_{ji} - \sum_{j: (i,j) \in A} r_{ij} = 0, &
    && \text{ for all } i \in V
    && \text{(flow through node must be preserved)},
    \label{eq:N3KEB}
    \\
    0 \le r_{ij} \le u_{ij}, &
    && \text{ for all } (i, j) \in A
    && \text{(arcs must not be overflowed)}.
    \label{eq:JV5KC}
  \end{align}
  \label{eq:YA13L}
\end{subequations}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

One possible approach is to transform the above problem to a corresponding
minimum cost flow problem, which is known to have standard solution algorithms.
If we flood our network by pushing $u_{ij}$ through all arcs $(i,j) \in A$,
the node flow preservation constraints \eqref{eq:N3KEB} get violated imposing
imbalances $e_i$ in some nodes. The sum of arc flows in the flooded network is
then
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{subequations}
  \begin{equation}
    z(u) = \sum_{(i,j) \in A} u_{ij},
    \label{eq:I4AB9}
  \end{equation}
   with
  \begin{align}
    \sum_{j: (j,i) \in A} u_{ji} - \sum_{j: (i,j) \in A} u_{ij} = e_i, &
    && \text{ for all } i \in V
    && \text{(imbalance in node)}.
    \label{eq:T1XA8}
  \end{align}
  \label{eq:D2Y3O}
\end{subequations}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Nodes with $e_i = 0$ will be called {\em balanced}, with $e_i < 0$ -- {\em
deficit}, and with $e_i > 0$ -- {\em excess}.

The flow $u = \left\lbrace u_{ij} \right\rbrace$ may be decomposed onto $r =
\left\lbrace r_{ij}\right\rbrace$ and~$x = \left\lbrace x_{ij} \right\rbrace$
as follows
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{subequations}
  \begin{equation}
    z(u) = z(r) + z(x)
    \label{eq:6M1IM}
  \end{equation}
  with the following properties
  \begin{align}
    \sum_{j: (j,i) \in A} r_{ji} - \sum_{j: (i,j) \in A} r_{ij} = 0, &
    && \text{ for all } i \in V
    && \text{(circular flow)},
    \label{eq:7FT2U}
    \\
    \sum_{j: (j,i) \in A} x_{ji} - \sum_{j: (i,j) \in A} x_{ij} = e_i, &
    && \text{ for all } i \in V
    && \text{(remaining flow)},
    \label{eq:VXBVY}
    \\
    r_{ij} \ge 0 \land x_{ij} \ge 0, &
    && \text{ for all } (i, j) \in A
    && \text{(flow components are non-negative)},
    \label{eq:WDOJ8}
    \\
    r_{ij} + x_{ij} = u_{ij}, &
    && \text{ for all } (i, j) \in A
    && \text{(decomposition of single arc flow)}.
    \label{eq:K3II1}
  \end{align}
  \label{eq:KSU4J}
\end{subequations}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The decomposition \eqref{eq:KSU4J} is non-unique. For example, $(x, r) = (u, 0)$
is feasible for any input data $(G,u)$, but it's almost never optimal ($z(r) = 0$).
Among all the feasible decompositions \eqref{eq:KSU4J}, there is at least one
optimal $(x^{*}, r^{*})$ having maximum circulation $z(r^{*})$. But the same
decomposition will also have minimum $z(x^{*})$ -- see~\eqref{eq:6M1IM}. What
follows is, that searching for maximum circulation $z(r^{*})$ is equivalent to
searching for a~flow $x^{*}$ of minimum cost $z(x^{*})$. The problem might be
now restated as follows.

\paragraph{Minimum cost flow.} Minimize the flow cost
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{subequations}
  \begin{equation}
    z(x) = \sum_{(i,j) \in A}{x_{ij}}
    \label{eq:0NZPS}
  \end{equation}
  subject to
  \begin{align}
    \sum_{j: (j,i) \in A}{x_{ji}} - \sum_{j: (i,j) \in A}{x_{ij}} = e_i, &
    && \text{ for all } i \in V, &&
    \label{eq:NMX02}
    \\
    0 \le x_{ij} \le u_{ij}, &
    && \text{ for all } (i,j) \in A. &&
    \label{eq:O0QTB}
  \end{align}
  \label{eq:A20W8}
\end{subequations}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
This is a standard minimum cost flow problem with arc costs $c_{ij} = 1$, for
all $(i,j) \in A$ and node supplies $b_i = -e_i$.

\paragraph{Path and cycle flow.} There is a~flow decomposition
theorem~\cite{ahuja1993network} saying that an arc flow (say, $u$)
may be decomposed onto path and cycle flow ($x$ and $r$ in our case: $u = x + r$).
The decomposition is non-unique -- in general, there are multiple ways to
decompose given arc flow $u$, yielding different values of $(z(x), z(r))$. In
the maximum circulation problem, we look for a~decomposition $(x^{*},r^{*})$
having maximum cycle flow $z(r^{*})$, or, alternatively, having minimum cost
$z(x^{*})$ of its path flow. The path flow $x$ can be expressed as
a~superposition of prescribed flows $f(P_{kl})$ along individual paths $P_{kl}
\subseteq A$ connecting deficit nodes $k \in D = \left\lbrace i: e_i < 0
\right\rbrace$ to excess nodes $l \in E = \left\lbrace i: e_i > 0\right\rbrace$,
that is
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{equation}
  x_{ij} = \sum_{P_{kl}: (i,j) \in P_{kl}}{f(P_{kl})}.
  \label{eq:AIKU9}
\end{equation}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\paragraph{Algorithm outline.}
The proposed method is similar to the {\em consecutive shortest paths}
algorithm~\cite{ahuja1993network}. We'll identify and subtract path flows
$f(P_{kl})$ along paths $P_{kl}$ connecting deficit nodes to excess nodes.
The contribution of a~single path $P_{kl}$ to the cost $z(x)$ is $f(P_{kl})
\cdot |P_{kl}|$, where $|P_{kl}|$ is the length of $P_{kl}$. The total cost can
thus be expressed as
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{equation}
  z(x) = \sum_{P_{kl} \in \mathcal{P}}{f(P_{kl}) \cdot |P_{kl}|},
  \label{eq:0SQMY}
\end{equation}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
where $\mathcal{P}$ denotes a~set of all paths selected to carry the path flow.
To find a~path flow $x$ of minimum cost, each $P_{kl} \in \mathcal{P}$ must be
a~shortest path from $k$ to $l$. For any fixed set of values $f(P_{kl})$,
taking longer paths would inevitably generate higher cost $z(x)$ (which is
evident from \eqref{eq:0SQMY}). On the other hand, as the path flow $x$ models
the component of flood $u$ entirely responsible for imbalances $e_i$, it must
then hold
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{equation}
  \sum_{P_{kl} \in \mathcal{P}}{f(P_{kl})} = \sum_{i \in D}{-e_i} = \sum_{i \in E}{e_i},
  \label{eq:QDPFI}
\end{equation}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
with deficit nodes $D = \left\lbrace i: e_i < 0\right\rbrace$ and excess nodes
$E = \left\lbrace i: e_i > 0\right\rbrace$. Moreover, the sum of path flows
originating from any deficit node $k \in D$ must be
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{equation}
  \begin{aligned}
    & \sum_{l: P_{kl} \in \mathcal{P}}{f(P_{kl})} = -e_k, && \text{ for all } k \in D, &
  \end{aligned}
  \label{eq:I9S7G}
\end{equation}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
and the sum of path flows sinking to any excess node $l \in E$ must be
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{equation}
  \begin{aligned}
    & \sum_{k: P_{kl} \in \mathcal{P}}{f(P_{kl})} = e_l, && \text{ for all } l \in E. &
  \end{aligned}
  \label{eq:MW3RR}
\end{equation}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The flooded network corresponds to a~residual network $G(x^0)$ with $x^0 = 0$
and residual capacities $r^0 = u$\footnote{For our purposes, we define
a~residual network $G(x^{\eta})$ w.r.t pseudo-flow $x^{\eta}$ as a graph $G$
having arc capacities $r_{ij} = u_{ij} - x^{\eta}_{ij}$.}. We treat the
circular pseudo-flow $r$ as residual capacities and will modify it from
iteration to iteration. At each iteration $\eta$, a~pair $(k,l) \in D \times E$
of imbalanced nodes is selected and a~flow along a~shortest path $P_{kl}$ from
$k$ to $l$ is determined
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{equation}
  f(P_{kl}) = \min_{(i,j) \in P_{kl}}{\left\lbrace -e_k, e_l, r^{\eta}_{ij} \right\rbrace}.
  \label{eq:WCR8C}
\end{equation}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
The flow $f(P_{kl})$ is then added to $x$ and subtracted from $r$ (network
update):
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{equation}
  \begin{aligned}
    & x^{\eta+1}_{ij} = x^{\eta}_{ij} + f(P_{kl}) && \text{ for all } (i,j) \in P_{kl}, &
    \\
    & r^{\eta+1}_{ij} = r^{\eta}_{ij} - f(P_{kl}) && \text{ for all } (i,j) \in P_{kl}, &
    \\
    & e^{\eta+1}_k = e^{\eta}_k + f(P_{kl}), &
    & \text{ also, if } e^{\eta+1}_k = 0, \text{ then remove }k \text{ from } D, &
    \\
    & e^{\eta+1}_l = e^{\eta}_k - f(P_{kl}), &
    & \text{ also, if } e^{\eta+1}_l = 0, \text{ then remove }l \text{ from } E. &
  \end{aligned}
  \label{eq:WTLZT}
\end{equation}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Initial values for the iteration are
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{equation}
  \begin{aligned}
    & x^0 = 0, && r^0 = u. &
  \end{aligned}
\end{equation}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
The iteration ends when $D$ is empty. Excess nodes exist as long as at least
one deficit node exist (guaranteed by the property $\sum_{i \in D} -e_i =
\sum_{i \in E} e_i$ (see~\eqref{eq:QDPFI}). After the last iteration $\eta$,
both $D$ and $E$ are empty -- the network is balanced, i.e. $r$ satisfies node
balance constraints~\eqref{eq:N3KEB}. The maximum circulation is then $z(r^{*})
= z(r^{\eta})$.

The actual algorithm does not maintain $x$, as we only interested in $r$. It's,
thus, just enough to keep track of $r$, $e_i$, $D$ and $E$ only.

\paragraph{Strongly connected components.} To guarantee correctness of the
above algorithm, certain assumptions must be made. For example, the
textbook~\cite{ahuja1993network} provides a list of assumptions, among which
there is one we haven't discussed yet:

{\em Assumption 9.4}~\cite{ahuja1993network}. {\em The network $G$ contains an
uncapacitated directed path (i.e. each arc in the path has infinite capacity)
between every pair of nodes}.

The textbook imposes this condition by adding {\em artificial} arcs $(1, j)$
and $(j, 1)$ for each $j \in N$ and assigning a~large cost and infinite
capacity to each of these arcs (no such arc would appear in a minimum cost
solution [\dots]).

We won't implement arc costs, as we have implicitly assumed $c_{ij} = 1$.
Instead of adding artificial arcs, we'd rather impose similar condition by
removing certain parts of $G$ -- bridges, and leaving only strongly connected
components for further processing.

A~directed graph is called strongly connected if there is a~path in each
direction between each pair of nodes (a~path exist from the first node of the
pair to the second, and another path exists from the second to the first). This
means, that
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{itemize}
  \item every node, as well as every arc, of a~strongly connected graph
    participates in at least one cycle.
\end{itemize}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
It shall be noted, that the circulation $z(r)$ is a sum of flows along cycles
and, thus, it's enclosed entirely within strongly connected components of $G$.
Eventual bridges between strongly connected components can not contribute to
the circulation (the condensation graph is acyclic). We can thus just remove
bridges from $G$, and solve our problem on the new graph consisting of isolated
strongly connected components only. Identification of bridges for removal can
be done in $\mathcal{O}(|V| + |A|)$ using Tarjan algorithm.

\bibliographystyle{unsrtnat}
\bibliography{leetcode}

\end{document}


% vim: set syntax=tex tabstop=2 shiftwidth=2 expandtab spell spelllang=en:
